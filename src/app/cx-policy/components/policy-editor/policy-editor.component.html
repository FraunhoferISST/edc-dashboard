<!--
    Copyright (c) 2025 Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V.

    This program and the accompanying materials are made available under the
    terms of the Apache License, Version 2.0 which is available at
    https://www.apache.org/licenses/LICENSE-2.0

    SPDX-License-Identifier: Apache-2.0

    Contributors:
        Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V. - Catena-X Next Policy Builder
-->

<div class="grid gap-4 grid-cols-1 xl:grid-cols-3 xl:grid-rows-[auto_1fr] h-full">
  <div class="flex justify-center items-center xl:col-span-2 xl:row-span-1 bg-base-300 rounded-2xl shadow-xl p-4">
    <label class="select w-full">
      <span class="label">Select Policy Type</span>
      <select class="select w-full" [(ngModel)]="policyType" (ngModelChange)="onTypeChange($event)">
        <option [value]="Action.Access">Access Policy</option>
        <option [value]="Action.Use">Usage Policy</option>
      </select>
    </label>
  </div>

  <div class="xl:col-span-2 xl:row-span-1 bg-base-300 rounded-2xl shadow-xl overflow-y-auto">
    <div class="w-full h-full grid grid-cols-1 grid-rows-[auto_1fr] gap-4 p-4 pb-0">
      <label class="select w-full">
        <span class="label">Select Policy Template</span>
        <select class="select w-full" [(ngModel)]="currentTemplate" (ngModelChange)="onConfigSelectionChange($event)">
          @for (template of templates; track template.policy) {
            <option [ngValue]="template">{{ template.name }}</option>
          }
        </select>
      </label>
      <app-policy-builder
        class="h-full"
        (policyChange)="onConfigChange($event)"
        [policyConfig]="currentTemplate"
      ></app-policy-builder>
    </div>
  </div>

  <div class="xl:row-span-2 xl:col-start-3 xl:row-start-1 relative overflow-auto rounded-2xl shadow-xl bg-base-300">
    <div
      class="relative 2xl:absolute 2xl:top-4 2xl:right-4 z-10 flex justify-between items-center w-full 2xl:w-fit p-4 pb-0 2xl:p-0"
    >
      @if (edcClientService.isHealthy$ | async) {
        @if (validationLoading) {
          <button class="btn btn-sm btn-circle btn-disabled 2xl:mx-4 p-1 !shadow-md !bg-primary !text-primary-content">
            <span class="loading loading-spinner"></span>
          </button>
        } @else if (isValid) {
          <div class="tooltip tooltip-secondary 2xl:tooltip-bottom tooltip-right" data-tip="Policy is valid">
            <button
              class="btn btn-sm btn-circle btn-disabled 2xl:mx-4 p-1 !shadow-md !bg-secondary !text-secondary-content"
            >
              <span class="material-symbols-rounded">check</span>
            </button>
          </div>
        } @else if (!isValid) {
          <div class="tooltip 2xl:tooltip-bottom tooltip-right" data-tip="Policy is invalid">
            <button class="btn btn-sm btn-circle btn-disabled 2xl:mx-4 p-1 !shadow-md !bg-error !text-error-content">
              <span class="material-symbols-rounded">error</span>
            </button>
          </div>
        }
      } @else {
        <div
          class="tooltip 2xl:tooltip-bottom tooltip-right"
          data-tip="For policy validation you need a connection to a connector."
        >
          <button
            class="btn btn-sm btn-circle btn-disabled 2xl:mx-4 p-1 !shadow-md !bg-neutral !text-neutral-content opacity-60"
          >
            <span class="material-symbols-rounded">question_mark</span>
          </button>
        </div>
      }
      <div
        class="tabs tabs-box shadow-md bg-base-100 [&_input]:checked:!bg-primary/8 [&_input]:checked:!text-primary [&_input]:hover:text-primary"
      >
        <div class="tooltip-left tooltip-primary tooltip" data-tip="Show legal information text of constraints.">
          <input
            type="radio"
            name="contract-types"
            class="tab"
            aria-label="Legal Text"
            [checked]="showLegalText"
            (change)="showLegalText = true"
          />
        </div>
        <div class="tooltip-left tooltip-primary tooltip" data-tip="Show JSON-LD policy definition.">
          <input
            type="radio"
            name="contract-types"
            class="tab"
            aria-label="JSON-LD"
            [checked]="!showLegalText"
            (change)="showLegalText = false"
          />
        </div>
      </div>
    </div>
    <button
      tabindex="0"
      class="btn btn-soft btn-primary fixed right-8 bottom-8 z-10 shadow-md"
      title="Copy to clipboard"
      (click)="copyPolicyToClipboard()"
    >
      <span class="material-symbols-rounded">content_copy</span>
      Copy JSON-LD
    </button>
    @if (!isValid) {
      <div class="w-full p-3 pb-0 box-border">
        <div class="w-full p-3 2xl:pt-5 mb-0 rounded-xl bg-error/80 text-error-content">
          <p class="text-lg font-bold">Invalid Policy</p>
          <p class="2xl:pt-2">{{ validationErrorText }}</p>
        </div>
      </div>
    }
    @if (showLegalText) {
      <div class="w-full h-full p-6">
        <p class="text-2xl">Legal Information</p>
        <div
          class="pl-2 pb-16 [&_div]:border-base-content/15 text-base-content/50 [&_div]:border-l-1 [&_div]:ml-1 [&_div]:pl-3"
        >
          @for (kind of legalTextKinds; track kind) {
            <p class="text-xl capitalize text-base-content mt-2">{{ kind }}</p>
            @for (permission of getPolicyPermission(kind); track permission.name) {
              <div class="[&_a]:link [&_a]:link-secondary">
                <p>Name: {{ permission.name }}</p>
                @for (constraint of getAtomicConstraints(permission.constraints); track constraint.leftOperand) {
                  <div>
                    <p>Constraint: {{ camelCaseToWords(constraint.leftOperand) }}</p>
                    @for (operand of getRightOperandArray(constraint.rightOperandValue); track operand.name) {
                      <div>
                        <span>Right Operand: </span>
                        <span class="font-thin text-primary">{{ camelCaseToWords(operand.name) }}</span>
                        <div>
                          @switch (kind) {
                            @case ('permissions') {
                              @if (operand.legalText?.permission) {
                                <p class="text-base-content" [innerHTML]="operand.legalText!.permission!"></p>
                              }
                            }
                            @case ('obligations') {
                              @if (operand.legalText?.obligation) {
                                <p class="text-base-content" [innerHTML]="operand.legalText!.obligation!"></p>
                              }
                            }
                            @case ('prohibitions') {
                              @if (operand.legalText?.prohibition) {
                                <p class="text-base-content" [innerHTML]="operand.legalText!.prohibition!"></p>
                              }
                            }
                          }
                          @if (operand.legalText?.additionalInformation) {
                            <div>
                              <span>Additional Information: </span>
                              <span class="text-base-content">{{ operand.legalText!.additionalInformation! }}</span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>
    } @else {
      <div class="mockup-code min-h-full">
        <ng-container *ngFor="let line of text.split('\n'); let i = index">
          <pre [attr.data-prefix]="i + 1"><code>{{ line }}</code></pre>
        </ng-container>
      </div>
    }
  </div>
</div>
